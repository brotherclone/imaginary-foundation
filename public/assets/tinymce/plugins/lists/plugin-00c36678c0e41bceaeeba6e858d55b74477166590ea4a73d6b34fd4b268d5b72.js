tinymce.PluginManager.add("lists",function(e){function t(t){return e.$.contains(e.getBody(),t)}function n(e){return e&&"BR"==e.nodeName}function i(e){return e&&/^(OL|UL|DL)$/.test(e.nodeName)&&t(e)}function r(e){return e&&/^(LI|DT|DD)$/.test(e.nodeName)}function o(e){return e.parentNode.firstChild==e}function a(e){return e.parentNode.lastChild==e}function s(t){return t&&!!e.schema.getTextBlockElements()[t.nodeName]}function l(t){return t===e.getBody()}function c(e){return e&&3===e.nodeType}function u(e,t){var n=tinymce.dom.RangeUtils.getNode(e,t);if(r(e)&&c(n)){var i=t>=e.childNodes.length?n.data.length:0;return{container:n,offset:i}}return{container:e,offset:t}}function d(e){var t=e.cloneRange(),n=u(e.startContainer,e.startOffset);t.setStart(n.container,n.offset);var i=u(e.endContainer,e.endOffset);return t.setEnd(i.container,i.offset),t}var f=this;e.on("init",function(){function c(e,t){var n=M.isEmpty(e);return!(t&&M.select("span[data-mce-type=bookmark]").length>0)&&n}function u(e){function t(t){var i,r,o;r=e[t?"startContainer":"endContainer"],o=e[t?"startOffset":"endOffset"],1==r.nodeType&&(i=M.create("span",{"data-mce-type":"bookmark"}),r.hasChildNodes()?(o=Math.min(o,r.childNodes.length-1),t?r.insertBefore(i,r.childNodes[o]):M.insertAfter(i,r.childNodes[o])):r.appendChild(i),r=i,o=0),n[t?"startContainer":"endContainer"]=r,n[t?"startOffset":"endOffset"]=o}var n={};return t(!0),e.collapsed||t(),n}function h(e){function t(t){function n(e){for(var t=e.parentNode.firstChild,n=0;t;){if(t==e)return n;1==t.nodeType&&"bookmark"==t.getAttribute("data-mce-type")||n++,t=t.nextSibling}return-1}var i,r,o;i=o=e[t?"startContainer":"endContainer"],r=e[t?"startOffset":"endOffset"],i&&(1==i.nodeType&&(r=n(i),i=i.parentNode,M.remove(o)),e[t?"startContainer":"endContainer"]=i,e[t?"startOffset":"endOffset"]=r)}t(!0),t();var n=M.createRng();n.setStart(e.startContainer,e.startOffset),e.endContainer&&n.setEnd(e.endContainer,e.endOffset),P.setRng(d(n))}function p(t,n){var i,r,o,a=M.createFragment(),s=e.schema.getBlockElements();if(e.settings.forced_root_block&&(n=n||e.settings.forced_root_block),n&&(r=M.create(n),r.tagName===e.settings.forced_root_block&&M.setAttribs(r,e.settings.forced_root_block_attrs),a.appendChild(r)),t)for(;i=t.firstChild;){var l=i.nodeName;o||"SPAN"==l&&"bookmark"==i.getAttribute("data-mce-type")||(o=!0),s[l]?(a.appendChild(i),r=null):n?(r||(r=M.create(n),a.appendChild(r)),r.appendChild(i)):a.appendChild(i)}return e.settings.forced_root_block?o||tinymce.Env.ie&&!(tinymce.Env.ie>10)||r.appendChild(M.create("br",{"data-mce-bogus":"1"})):a.appendChild(M.create("br")),a}function m(){return tinymce.grep(P.getSelectedBlocks(),function(e){return r(e)})}function g(e,t,n){function i(e){tinymce.each(a,function(n){e.parentNode.insertBefore(n,t.parentNode)}),M.remove(e)}var r,o,a,s;for(a=M.select('span[data-mce-type="bookmark"]',e),n=n||p(t),r=M.createRng(),r.setStartAfter(t),r.setEndAfter(e),o=r.extractContents(),s=o.firstChild;s;s=s.firstChild)if("LI"==s.nodeName&&M.isEmpty(s)){M.remove(s);break}M.isEmpty(o)||M.insertAfter(o,e),M.insertAfter(n,e),c(t.parentNode)&&i(t.parentNode),M.remove(t),c(e)&&M.remove(e)}function v(e){var t,n;if(t=e.nextSibling,t&&i(t)&&t.nodeName==e.nodeName&&I(e,t)){for(;n=t.firstChild;)e.appendChild(n);M.remove(t)}if(t=e.previousSibling,t&&i(t)&&t.nodeName==e.nodeName&&I(e,t)){for(;n=t.lastChild;)e.insertBefore(n,e.firstChild);M.remove(t)}}function y(e){tinymce.each(tinymce.grep(M.select("ol,ul",e)),b)}function b(e){var t,n=e.parentNode;"LI"==n.nodeName&&n.firstChild==e&&(t=n.previousSibling,t&&"LI"==t.nodeName?(t.appendChild(e),c(n)&&M.remove(n)):M.setStyle(n,"listStyleType","none")),i(n)&&(t=n.previousSibling,t&&"LI"==t.nodeName&&t.appendChild(e))}function x(e){function t(e){c(e)&&M.remove(e)}var n,r=e.parentNode,s=r.parentNode;return!(!l(r)&&("DD"==e.nodeName?(M.rename(e,"DT"),0):o(e)&&a(e)?("LI"==s.nodeName?(M.insertAfter(e,s),t(s),M.remove(r)):i(s)?M.remove(r,!0):(s.insertBefore(p(e),r),M.remove(r)),0):o(e)?("LI"==s.nodeName?(M.insertAfter(e,s),e.appendChild(r),t(s)):i(s)?s.insertBefore(e,r):(s.insertBefore(p(e),r),M.remove(e)),0):a(e)?("LI"==s.nodeName?M.insertAfter(e,s):i(s)?M.insertAfter(e,r):(M.insertAfter(p(e),r),M.remove(e)),0):("LI"==s.nodeName?(r=s,n=p(e,"LI")):n=i(s)?p(e,"LI"):p(e),g(r,e,n),y(r.parentNode),0)))}function w(e){function t(t,n){var r;if(i(t)){for(;r=e.lastChild.firstChild;)n.appendChild(r);M.remove(t)}}var n,r,o;return"DT"==e.nodeName?(M.rename(e,"DD"),!0):(n=e.previousSibling,n&&i(n)?(n.appendChild(e),!0):n&&"LI"==n.nodeName&&i(n.lastChild)?(n.lastChild.appendChild(e),t(e.lastChild,n.lastChild),!0):(n=e.nextSibling,n&&i(n)?(n.insertBefore(e,n.firstChild),!0):(n=e.previousSibling,!(!n||"LI"!=n.nodeName||(r=M.create(e.parentNode.nodeName),o=M.getStyle(e.parentNode,"listStyleType"),o&&M.setStyle(r,"listStyleType",o),n.appendChild(r),r.appendChild(e),t(e.lastChild,r),0)))))}function C(){var t=m();if(t.length){for(var n=u(P.getRng(!0)),i=0;i<t.length&&(w(t[i])||0!==i);i++);return h(n),e.nodeChanged(),!0}}function _(){var t=m();if(t.length){var n,i,r=u(P.getRng(!0)),o=e.getBody();for(n=t.length;n--;)for(var a=t[n].parentNode;a&&a!=o;){for(i=t.length;i--;)if(t[i]===a){t.splice(n,1);break}a=a.parentNode}for(n=0;n<t.length&&(x(t[n])||0!==n);n++);return h(r),e.nodeChanged(),!0}}function k(t,r){function o(){function t(e){var t,n;for(t=l[e?"startContainer":"endContainer"],n=l[e?"startOffset":"endOffset"],1==t.nodeType&&(t=t.childNodes[Math.min(n,t.childNodes.length-1)]||t);t.parentNode!=o;){if(s(t))return t;if(/^(TD|TH)$/.test(t.parentNode.nodeName))return t;t=t.parentNode}return t}for(var i,r=[],o=e.getBody(),a=t(!0),c=t(),u=[],d=a;d&&(u.push(d),d!=c);d=d.nextSibling);return tinymce.each(u,function(e){if(s(e))return r.push(e),void(i=null);if(M.isBlock(e)||n(e))return n(e)&&M.remove(e),void(i=null);var t=e.nextSibling;return tinymce.dom.BookmarkManager.isBookmarkNode(e)&&(s(t)||!t&&e.parentNode==o)?void(i=null):(i||(i=M.create("p"),e.parentNode.insertBefore(i,e),r.push(i)),void i.appendChild(e))}),r}var a,l=P.getRng(!0),c="LI";"false"!==M.getContentEditable(P.getNode())&&(t=t.toUpperCase(),"DL"==t&&(c="DT"),a=u(l),tinymce.each(o(),function(e){var n,o,a=function(e){var t=M.getStyle(e,"list-style-type"),n=r?r["list-style-type"]:"";return n=null===n?"":n,t===n};o=e.previousSibling,o&&i(o)&&o.nodeName==t&&a(o)?(n=o,e=M.rename(e,c),o.appendChild(e)):(n=M.create(t),e.parentNode.insertBefore(n,e),n.appendChild(e),e=M.rename(e,c)),L(n,r),v(n)}),h(a))}function S(){var t=u(P.getRng(!0)),n=e.getBody(),r=m(),o=tinymce.util.Tools.grep(r,function(e){return c(e)});r=tinymce.util.Tools.grep(r,function(e){return!c(e)}),tinymce.each(o,function(e){if(c(e))return void x(e)}),tinymce.each(r,function(e){var t,r;if(!l(e.parentNode)){for(t=e;t&&t!=n;t=t.parentNode)i(t)&&(r=t);g(r,e),y(r.parentNode)}}),h(t)}function E(e,t){var n=M.getParent(P.getStart(),"OL,UL,DL");if(!l(n))if(n)if(n.nodeName==e)S(e);else{var i=u(P.getRng(!0));L(n,t),v(M.rename(n,e)),h(i)}else k(e,t)}function T(t){return function(){var n=M.getParent(e.selection.getStart(),"UL,OL,DL");return n&&n.nodeName==t}}function N(e){return!!n(e)&&!(!M.isBlock(e.nextSibling)||n(e.previousSibling))}function D(t,n){var i,r,o=t.startContainer,a=t.startOffset;if(3==o.nodeType&&(n?a<o.data.length:a>0))return o;for(i=e.schema.getNonEmptyElements(),1==o.nodeType&&(o=tinymce.dom.RangeUtils.getNode(o,a)),r=new tinymce.dom.TreeWalker(o,e.getBody()),n&&N(o)&&r.next();o=r[n?"next":"prev2"]();){if("LI"==o.nodeName&&!o.hasChildNodes())return o;if(i[o.nodeName])return o;if(3==o.nodeType&&o.data.length>0)return o}}function $(e,r){var o,a,s=e.parentNode;if(t(e)&&t(r)){if(i(r.lastChild)&&(a=r.lastChild),s==r.lastChild&&n(s.previousSibling)&&M.remove(s.previousSibling),o=r.lastChild,o&&n(o)&&e.hasChildNodes()&&M.remove(o),c(r,!0)&&M.$(r).empty(),!c(e,!0))for(;o=e.firstChild;)r.appendChild(o);a&&r.appendChild(a),M.remove(e),c(s)&&!l(s)&&M.remove(s)}}function A(e){var t,n,i,r=M.getParent(P.getStart(),"LI");if(r){if(t=r.parentNode,l(t)&&M.isEmpty(t))return!0;if(n=d(P.getRng(!0)),i=M.getParent(D(n,e),"LI"),i&&i!=r){var o=u(n);return e?$(i,r):$(r,i),h(o),!0}if(!i&&!e&&S(t.nodeName))return!0}}function R(){var t=e.dom.getParent(e.selection.getStart(),"LI,DT,DD");return!!(t||m().length>0)&&(e.undoManager.transact(function(){e.execCommand("Delete"),y(e.getBody())}),!0)}var M=e.dom,P=e.selection,I=function(t,n){var i=e.dom.getStyle(t,"list-style-type",!0),r=e.dom.getStyle(n,"list-style-type",!0);return i===r},L=function(e,t){M.setStyle(e,"list-style-type",t?t["list-style-type"]:null)};f.backspaceDelete=function(e){return P.isCollapsed()?A(e):R()},e.on("BeforeExecCommand",function(t){var n,i=t.command.toLowerCase();if("indent"==i?C()&&(n=!0):"outdent"==i&&_()&&(n=!0),n)return e.fire("ExecCommand",{command:t.command}),t.preventDefault(),!0}),e.addCommand("InsertUnorderedList",function(e,t){E("UL",t)}),e.addCommand("InsertOrderedList",function(e,t){E("OL",t)}),e.addCommand("InsertDefinitionList",function(e,t){E("DL",t)}),e.addQueryStateHandler("InsertUnorderedList",T("UL")),e.addQueryStateHandler("InsertOrderedList",T("OL")),e.addQueryStateHandler("InsertDefinitionList",T("DL")),e.on("keydown",function(t){9!=t.keyCode||tinymce.util.VK.metaKeyPressed(t)||e.dom.getParent(e.selection.getStart(),"LI,DT,DD")&&(t.preventDefault(),t.shiftKey?_():C())})});var h=function(t){return function(){var n=this;e.on("NodeChange",function(e){var r=tinymce.util.Tools.grep(e.parents,i);n.active(r.length>0&&r[0].nodeName===t)})}},p=function(e,t){var n=e.settings.plugins?e.settings.plugins:"";return tinymce.util.Tools.inArray(n.split(/[ ,]/),t)!==-1};p(e,"advlist")||(e.addButton("numlist",{title:"Numbered list",cmd:"InsertOrderedList",onPostRender:h("OL")}),e.addButton("bullist",{title:"Bullet list",cmd:"InsertUnorderedList",onPostRender:h("UL")})),e.addButton("indent",{icon:"indent",title:"Increase indent",cmd:"Indent",onPostRender:function(){var t=this;e.on("nodechange",function(){for(var n=e.selection.getSelectedBlocks(),i=!1,r=0,a=n.length;!i&&r<a;r++){var s=n[r].nodeName;i="LI"==s&&o(n[r])||"UL"==s||"OL"==s||"DD"==s}t.disabled(i)})}}),e.on("keydown",function(e){e.keyCode==tinymce.util.VK.BACKSPACE?f.backspaceDelete()&&e.preventDefault():e.keyCode==tinymce.util.VK.DELETE&&f.backspaceDelete(!0)&&e.preventDefault()})});